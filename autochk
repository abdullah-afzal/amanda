#!/bin/sh

# cd to the directory we're run from
cd `dirname $0`

die() {
    echo "$@"
    exit 1
}

toplevel=$(git rev-parse --show-toplevel)

[ -d config -a -d config/gettext-macros -a -d config/gnulib -a -d config/amanda -a -d config/macro-archive ] || die "ERROR: m4 include check failed"

#
# test absolute requirements for building with submodules checked out...
#
if [ ! -s config/set_full_version -a -L config/set_full_version ] || 
    [ ! -s bitrock-stack/build-var-subst.sh -a -L bitrock-stack ]
then
    # perform completed checkout of submodules ...
    [ -s $toplevel/.gitmodules ] || die "ERROR: no $toplevel/.gitmodules file was found but symlinks are broken."
    git submodule deinit -f .
    rm -rf 000-external   # to be certain nothing is checked out now...
    git submodule | sed -e 's,^.*000-external/,000-external/,' | xargs git checkout -f  >/dev/null 2>/dev/null
    git submodule init
fi

if [ -s $toplevel/.gitmodules ]; then
    git submodule update --rebase
    GITMODULES=${PWD}/.gitmodules \
        git >/dev/null 2>/dev/null submodule foreach \
            'branch=$(git config -f $GITMODULES --get submodule.$name.branch); [ -n "$branch" ] && git checkout $branch; git pull'
fi

[ -s config/set_full_version -a -L config/set_full_version ] || die "ERROR: cannot use config/set_full_version symlink.  submodule checkout failed."
[ -s bitrock-stack/build-var-subst.sh ] || die "ERROR: cannot use bitrock-stack symlink.  submodule checkout failed."

set -- awk make gcc sed libtoolize \
        autoconf automake autoheader \
        swig perl bison flex gettext mailx \
        dump xinetd smbclient git tar cpio \
        strip ar base64 openssl mtx

failed=""
export PATH="$PATH:/bin:/usr/bin:/sbin:/usr/sbin"
for i do eval 'type $1 >/dev/null' $i || failed="$failed $i"; done

if [ -n "$failed" ]; then die "ERROR: failed executible tests: $failed"; fi

set -- CPAN List::Util IO::Socket::SSL Carp Data::Dumper ExtUtils::Embed 
for i do perl -e "use $i;" || failed="$failed $i"; done

if [ -n "$failed" ]; then die "ERROR: failed executible tests: $failed"; fi

exit 0
